{% extends "base.html" %}

{% block title %}Settings - Doorbell Face Recognition{% endblock %}

{% block extra_head %}
<script src="static/js/settings.js" defer></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <h2><i class="bi bi-gear"></i> Settings</h2>
        <p class="text-muted">Configure your doorbell face recognition system</p>
        
        <!-- Camera Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-camera-video"></i> Camera Configuration</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Camera Source</label>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="camera-source" id="camera-url-option" value="url" {% if not settings.camera_entity %}checked{% endif %}>
                                <label class="form-check-label" for="camera-url-option">
                                    Manual URL
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="camera-source" id="camera-entity-option" value="entity" {% if settings.camera_entity %}checked{% endif %}>
                                <label class="form-check-label" for="camera-entity-option">
                                    Home Assistant Entity
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="camera-url-section" class="mb-3"{% if settings.camera_entity %} style="display: none;"{% endif %}>
                    <label for="camera-url" class="form-label">Camera URL</label>
                    <input type="text" class="form-control" id="camera-url" value="{{ settings.camera_url }}">
                    <div class="form-text">RTSP or HTTP URL for your doorbell camera</div>
                </div>
                
                <div id="camera-entity-section" class="mb-3"{% if not settings.camera_entity %} style="display: none;"{% endif %}>
                    <label for="camera-entity" class="form-label">Camera Entity</label>
                    <select class="form-select" id="camera-entity" data-current-value="{{ settings.camera_entity or '' }}">
                        <option value="">Loading cameras...</option>
                    </select>
                    <div class="form-text">Select a camera entity from Home Assistant</div>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" onclick="testCamera()">
                        <i class="bi bi-play-circle"></i> Test Camera Connection
                    </button>
                    <button class="btn btn-success" onclick="saveSettings()">
                        <i class="bi bi-check-circle"></i> Save Settings
                    </button>
                </div>
                <span id="camera-status" class="ms-2"></span>
            </div>
        </div>
        
        <!-- Face Recognition Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Face Recognition</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="confidence-threshold" class="form-label">
                        Confidence Threshold: <span id="confidence-value">{{ "%.1f"|format(settings.face_confidence_threshold * 100) }}%</span>
                    </label>
                    <input type="range" 
                           class="form-range" 
                           id="confidence-threshold" 
                           min="10" 
                           max="95" 
                           value="{{ settings.face_confidence_threshold * 100 }}"
                           oninput="updateConfidenceValue(this.value)">
                    <div class="form-text">Higher values require more confident matches (recommended: 60-80%)</div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="card-title text-light">Known Faces Detected</h6>
                                <h3 class="text-success" id="known-faces-count">-</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h6 class="card-title text-light">Total Face Encodings</h6>
                                <h3 class="text-info" id="face-encodings-count">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Storage Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hdd"></i> Storage Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="retention-days" class="form-label">Data Retention (Days)</label>
                    <input type="number" class="form-control" id="retention-days" value="{{ settings.retention_days }}" min="1" max="365">
                    <div class="form-text">Images and events older than this will be automatically deleted</div>
                </div>
                
                <div class="mb-3">
                    <label for="storage-path" class="form-label">Storage Path</label>
                    <input type="text" class="form-control" id="storage-path" value="{{ settings.storage_path }}">
                    <div class="form-text">Path where doorbell images and data are stored</div>
                </div>
                
                <button class="btn btn-success mb-3" onclick="saveStorageSettings()">
                    <i class="bi bi-save"></i> Save Storage Settings
                </button>
                
                <!-- Storage Usage -->
                <div class="mb-3">
                    <label class="form-label">Storage Usage</label>
                    <div class="progress mb-2">
                        <div class="progress-bar" 
                             role="progressbar" 
                             style="width: {{ storage_info.usage_percent|default(0) }}%"
                             aria-valuenow="{{ storage_info.usage_percent|default(0) }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-muted">
                        {{ "%.1f"|format(storage_info.used_gb) }} GB / {{ "%.1f"|format(storage_info.total_gb) }} GB used
                        ({{ "%.1f"|format(storage_info.usage_percent) }}%)
                    </small>
                </div>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" onclick="cleanupOldData()">
                        <i class="bi bi-trash"></i> Cleanup Old Data
                    </button>
                    <button class="btn btn-info" onclick="refreshStorageInfo()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Storage Info
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Home Assistant Integration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-house"></i> Home Assistant Integration</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="ha-access-token" class="form-label">Long-lived Access Token (Optional)</label>
                    <input type="password" 
                           class="form-control" 
                           id="ha-access-token" 
                           value="{{ settings.ha_access_token or '' }}" 
                           placeholder="Enter your Home Assistant long-lived access token">
                    <div class="form-text">
                        Required for camera entity discovery. Create in Home Assistant: Profile → Security → Long-lived access tokens
                    </div>
                </div>
                
                <button class="btn btn-info" onclick="refreshCameraEntities()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Camera Entities
                </button>
            </div>
        </div>
        
        <!-- Weather Integration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cloud-sun"></i> Weather Integration</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="weather-entity" class="form-label">Weather Entity (Optional)</label>
                    <select class="form-select" id="weather-entity" data-current-value="{{ settings.weather_entity or '' }}">
                        <option value="">Select a weather entity...</option>
                    </select>
                    <div class="form-text">
                        Choose a Home Assistant weather entity to capture weather conditions with each doorbell event.
                        Weather data will be displayed in the dashboard and gallery.
                    </div>
                </div>
                
                <button class="btn btn-success mb-3" onclick="saveWeatherSettings()">
                    <i class="bi bi-save"></i> Save Weather Settings
                </button>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Weather Data Captured:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Weather condition (sunny, cloudy, rainy, etc.)</li>
                        <li>Temperature (°C)</li>
                        <li>Humidity (%)</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Notification Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bell"></i> Notifications</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="webhook-url" class="form-label">Webhook URL (Optional)</label>
                    <input type="url" 
                           class="form-control" 
                           id="webhook-url" 
                           value="{{ settings.notification_webhook or '' }}" 
                           placeholder="https://your-webhook-url.com/notify">
                    <div class="form-text">
                        External webhook URL for notifications. Supports Gotify (e.g., https://gotify.example.com/message?token=YOUR_TOKEN) and generic webhooks.
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveWebhookUrl()">
                    <i class="bi bi-save"></i> Save Webhook URL
                </button>
                
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="ha-notifications" checked disabled>
                    <label class="form-check-label" for="ha-notifications">
                        Home Assistant Notifications (Always Enabled)
                    </label>
                </div>
                
                <button class="btn btn-primary mt-2" onclick="testNotifications()">
                    <i class="bi bi-send"></i> Test Notifications
                </button>
            </div>
        </div>
    </div>
    
    <!-- System Information -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Version:</strong></td>
                        <td>{{ settings.app_version }}</td>
                    </tr>
                    <tr>
                        <td><strong>Database:</strong></td>
                        <td>SQLite {% if settings.database_encryption %}<span class="badge bg-success">Encrypted</span>{% endif %}</td>
                    </tr>
                    <tr>
                        <td><strong>Camera Status:</strong></td>
                        <td><span id="camera-connection-status" class="badge bg-secondary">Unknown</span></td>
                    </tr>
                    <tr>
                        <td><strong>Face Recognition:</strong></td>
                        <td><span class="badge bg-success">Active</span></td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body d-grid gap-2">
                <button class="btn btn-primary" onclick="captureFrame()">
                    <i class="bi bi-camera"></i> Capture Test Frame
                </button>
                <button class="btn btn-info" onclick="reloadFaceEncodings()">
                    <i class="bi bi-arrow-clockwise"></i> Reload Face Encodings
                </button>
                <button class="btn btn-warning text-dark" onclick="exportData()">
                    <i class="bi bi-download"></i> Export Data
                </button>
                <button class="btn btn-danger" onclick="resetSystem()">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset System
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Statistics</h5>
            </div>
            <div class="card-body">
                <div id="stats-container">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load statistics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    checkCameraStatus();
});

// Update confidence threshold display
function updateConfidenceValue(value) {
    document.getElementById('confidence-value').textContent = value + '%';
}

// Load system statistics
async function loadStatistics() {
    try {
        const response = await fetch('api/stats');
        const stats = await response.json();
        
        const statsHtml = `
            <div class="row text-center">
                <div class="col-6 mb-3">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Total Events</h6>
                        <h4 class="text-primary">${stats.total_events}</h4>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Known Events</h6>
                        <h4 class="text-success">${stats.known_events}</h4>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Unknown Events</h6>
                        <h4 class="text-warning">${stats.unknown_events}</h4>
                    </div>
                </div>
                <div class="col-6 mb-3">
                    <div class="border rounded p-2">
                        <h6 class="mb-1">Registered People</h6>
                        <h4 class="text-info">${stats.total_persons}</h4>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('stats-container').innerHTML = statsHtml;
        
        // Update face counts
        document.getElementById('known-faces-count').textContent = stats.known_events;
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('stats-container').innerHTML = '<p class="text-danger">Error loading statistics</p>';
    }
}

// Test camera connection
async function testCamera() {
    const statusElement = document.getElementById('camera-status');
    statusElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Testing...';
    
    try {
        const response = await fetch('api/camera/capture', { method: 'POST' });
        
        if (response.ok) {
            statusElement.innerHTML = '<span class="badge bg-success">✓ Camera Connected</span>';
            document.getElementById('camera-connection-status').className = 'badge bg-success';
            document.getElementById('camera-connection-status').textContent = 'Connected';
        } else {
            statusElement.innerHTML = '<span class="badge bg-danger">✗ Camera Error</span>';
            document.getElementById('camera-connection-status').className = 'badge bg-danger';
            document.getElementById('camera-connection-status').textContent = 'Error';
        }
    } catch (error) {
        statusElement.innerHTML = '<span class="badge bg-danger">✗ Connection Failed</span>';
        document.getElementById('camera-connection-status').className = 'badge bg-danger';
        document.getElementById('camera-connection-status').textContent = 'Failed';
    }
}

// Check camera status on load
async function checkCameraStatus() {
    try {
        // This is a lightweight check - we'll just see if we can reach the API
        const response = await fetch('api/settings');
        if (response.ok) {
            document.getElementById('camera-connection-status').className = 'badge bg-success';
            document.getElementById('camera-connection-status').textContent = 'Ready';
        }
    } catch (error) {
        document.getElementById('camera-connection-status').className = 'badge bg-warning';
        document.getElementById('camera-connection-status').textContent = 'Unknown';
    }
}

// Test notifications
async function testNotifications() {
    try {
        const response = await fetch('api/notifications/test', { method: 'POST' });
        
        if (response.ok) {
            const data = await response.json();
            alert(data.message || 'Test notification sent! Check your Home Assistant notifications and webhook.');
        } else {
            const error = await response.json();
            alert('Error sending test notification: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error testing notifications: ' + error.message);
    }
}

// Save webhook URL
async function saveWebhookUrl() {
    try {
        const webhookUrl = document.getElementById('webhook-url').value;
        
        const response = await fetch('api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                notification_webhook: webhookUrl
            })
        });
        
        if (response.ok) {
            alert('Webhook URL saved successfully!');
        } else {
            const error = await response.json();
            alert('Error saving webhook URL: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving webhook URL: ' + error.message);
    }
}

// Reload face encodings
async function reloadFaceEncodings() {
    try {
        // This would typically be a dedicated endpoint, but we'll simulate it
        const response = await fetch('api/persons');
        
        if (response.ok) {
            alert('Face encodings reloaded successfully!');
            loadStatistics();
        } else {
            alert('Error reloading face encodings');
        }
    } catch (error) {
        alert('Error reloading face encodings: ' + error.message);
    }
}

// Cleanup old data
function cleanupOldData() {
    showConfirmModal(
        'Are you sure you want to cleanup old data? This will permanently delete images and events older than the retention period.',
        async function() {
            try {
                const response = await fetch('api/storage/cleanup', { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message || 'Cleanup completed! Old data has been removed.');
                    await refreshStorageInfo();
                    loadStatistics();
                } else {
                    const error = await response.json();
                    alert('Error during cleanup: ' + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                alert('Error during cleanup: ' + error.message);
            }
        }
    );
}

// Save storage settings
async function saveStorageSettings() {
    try {
        const retentionDays = parseInt(document.getElementById('retention-days').value);
        const storagePath = document.getElementById('storage-path').value;
        
        // Validate retention days
        if (retentionDays < 1 || retentionDays > 365) {
            alert('Retention days must be between 1 and 365');
            return;
        }
        
        // Validate storage path
        if (!storagePath || storagePath.trim() === '') {
            alert('Storage path cannot be empty');
            return;
        }
        
        const response = await fetch('api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                retention_days: retentionDays,
                storage_path: storagePath
            })
        });
        
        if (response.ok) {
            alert('Storage settings saved successfully!');
            await refreshStorageInfo();
        } else {
            const error = await response.json();
            alert('Error saving storage settings: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving storage settings: ' + error.message);
    }
}

// Refresh storage info
async function refreshStorageInfo() {
    try {
        const response = await fetch('api/storage/info');
        
        if (response.ok) {
            const data = await response.json();
            
            // Update storage usage display
            const progressBar = document.querySelector('.progress-bar');
            const usageText = document.querySelector('.text-muted');
            
            if (progressBar) {
                progressBar.style.width = data.usage_percent + '%';
                progressBar.setAttribute('aria-valuenow', data.usage_percent);
            }
            
            if (usageText) {
                usageText.textContent = `${data.used_gb.toFixed(1)} GB / ${data.total_gb.toFixed(1)} GB used (${data.usage_percent.toFixed(1)}%)`;
            }
            
            console.log('Storage info refreshed successfully');
        } else {
            console.error('Failed to refresh storage info');
            // Fallback to page reload if API fails
            location.reload();
        }
    } catch (error) {
        console.error('Error refreshing storage info:', error);
        // Fallback to page reload if API fails
        location.reload();
    }
}

// Export data
async function exportData() {
    try {
        // This would typically generate a download link
        alert('Data export feature coming soon! This will allow you to backup your face encodings and settings.');
    } catch (error) {
        alert('Error exporting data: ' + error.message);
    }
}

// Reset system
function resetSystem() {
    showConfirmModal(
        'WARNING: This will permanently delete ALL data including face encodings, events, and images. This action cannot be undone!',
        async function() {
            try {
                // This would be a dedicated reset endpoint
                alert('System reset feature requires manual intervention for safety. Please contact support.');
            } catch (error) {
                alert('Error resetting system: ' + error.message);
            }
        }
    );
}

// Show confirmation modal
function showConfirmModal(message, onConfirm) {
    document.getElementById('confirm-message').textContent = message;
    
    const confirmBtn = document.getElementById('confirm-action-btn');
    confirmBtn.onclick = function() {
        bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
        onConfirm();
    };
    
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
}

// Auto-refresh statistics every 60 seconds
setInterval(loadStatistics, 60000);
</script>
{% endblock %}
