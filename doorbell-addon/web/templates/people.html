{% extends "base.html" %}

{% block title %}People Management - Doorbell Face Recognition{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="bi bi-people"></i> People Management</h2>
        <p class="text-muted">Manage registered people and their face encodings</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPersonModal">
            <i class="bi bi-person-plus"></i> Add New Person
        </button>
    </div>
</div>

<!-- People Grid -->
<div class="row">
    {% if persons %}
        {% for person in persons %}
        <div class="col-lg-4 col-md-6 mb-4" id="person-card-{{ person.id }}">
            <div class="card h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-person-circle"></i> {{ person.name }}
                    </h5>
                    <button class="btn btn-sm btn-danger" onclick="confirmDeletePerson({{ person.id }}, '{{ person.name }}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Person ID:</strong> {{ person.id }}<br>
                        <strong>Created:</strong> {{ person.created_at.strftime('%Y-%m-%d %H:%M') if person.created_at else 'N/A' }}<br>
                        <strong>Face Encodings:</strong> <span id="face-count-{{ person.id }}">Loading...</span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="addFaceModal({{ person.id }}, '{{ person.name }}')">
                            <i class="bi bi-plus-circle"></i> Add Face Image
                        </button>
                        <button class="btn btn-outline-info" onclick="viewPersonEvents({{ person.id }})">
                            <i class="bi bi-calendar-event"></i> View Events
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editPersonName({{ person.id }}, '{{ person.name }}')">
                            <i class="bi bi-pencil"></i> Rename
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle fs-1"></i>
                <h4 class="mt-3">No People Registered</h4>
                <p>Start by adding your first person to enable face recognition.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPersonModal">
                    <i class="bi bi-person-plus"></i> Add First Person
                </button>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add Person Modal -->
<div class="modal fade" id="addPersonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Person</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-person-form">
                    <div class="mb-3">
                        <label for="person-name" class="form-label">Person Name</label>
                        <input type="text" class="form-control" id="person-name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddPerson()">Add Person</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Face Modal -->
<div class="modal fade" id="addFaceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Face Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Add a face image for: <strong id="face-person-name"></strong></p>
                <input type="hidden" id="face-person-id">
                <div class="mb-3">
                    <label for="face-image" class="form-label">Select Image</label>
                    <input type="file" class="form-control" id="face-image" accept="image/*" required>
                </div>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> For best results, use a clear, well-lit photo with the face clearly visible.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddFace()">Add Face</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Person Name Modal -->
<div class="modal fade" id="editPersonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename Person</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-person-id">
                <div class="mb-3">
                    <label for="edit-person-name" class="form-label">New Name</label>
                    <input type="text" class="form-control" id="edit-person-name" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditPerson()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePersonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="delete-person-id">
                <p>Are you sure you want to delete <strong id="delete-person-name"></strong>?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> This will remove all face encodings for this person. Events will remain but will be marked as "Unknown".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitDeletePerson()">Delete Person</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load face encoding counts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFaceCounts();
});

async function loadFaceCounts() {
    try {
        const response = await fetch('api/persons');
        if (response.ok) {
            const persons = await response.json();
            persons.forEach(person => {
                const countElement = document.getElementById(`face-count-${person.id}`);
                if (countElement) {
                    countElement.textContent = person.face_count || 0;
                }
            });
        }
    } catch (error) {
        console.error('Error loading face counts:', error);
    }
}

// Add new person
async function submitAddPerson() {
    const name = document.getElementById('person-name').value.trim();
    if (!name) {
        alert('Please enter a person name');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('name', name);
        
        const response = await fetch('api/persons', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addPersonModal')).hide();
            location.reload();
        } else {
            const errorData = await response.json();
            alert('Error: ' + (errorData.detail || 'Failed to add person'));
        }
    } catch (error) {
        alert('Error adding person: ' + error.message);
    }
}

// Add face to person
function addFaceModal(personId, personName) {
    document.getElementById('face-person-id').value = personId;
    document.getElementById('face-person-name').textContent = personName;
    new bootstrap.Modal(document.getElementById('addFaceModal')).show();
}

async function submitAddFace() {
    const personId = document.getElementById('face-person-id').value;
    const imageFile = document.getElementById('face-image').files[0];
    
    if (!imageFile) {
        alert('Please select an image file');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('image', imageFile);
        
        const response = await fetch(`api/persons/${personId}/faces`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addFaceModal')).hide();
            alert('Face added successfully!');
            loadFaceCounts();
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error adding face: ' + error.message);
    }
}

// Edit person name
function editPersonName(personId, currentName) {
    document.getElementById('edit-person-id').value = personId;
    document.getElementById('edit-person-name').value = currentName;
    new bootstrap.Modal(document.getElementById('editPersonModal')).show();
}

async function submitEditPerson() {
    const personId = document.getElementById('edit-person-id').value;
    const newName = document.getElementById('edit-person-name').value.trim();
    
    if (!newName) {
        alert('Please enter a name');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('name', newName);
        
        const response = await fetch(`api/persons/${personId}`, {
            method: 'PUT',
            body: formData
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('editPersonModal')).hide();
            location.reload();
        } else {
            const errorData = await response.json();
            alert('Error: ' + (errorData.detail || 'Failed to update person'));
        }
    } catch (error) {
        alert('Error updating person: ' + error.message);
    }
}

// Delete person
function confirmDeletePerson(personId, personName) {
    document.getElementById('delete-person-id').value = personId;
    document.getElementById('delete-person-name').textContent = personName;
    new bootstrap.Modal(document.getElementById('deletePersonModal')).show();
}

async function submitDeletePerson() {
    const personId = document.getElementById('delete-person-id').value;
    
    try {
        const response = await fetch(`api/persons/${personId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deletePersonModal')).hide();
            document.getElementById(`person-card-${personId}`).remove();
            
            // Check if no more persons
            if (document.querySelectorAll('[id^="person-card-"]').length === 0) {
                location.reload();
            }
        } else {
            const error = await response.json();
            alert('Error: ' + error.detail);
        }
    } catch (error) {
        alert('Error deleting person: ' + error.message);
    }
}

// View person events
function viewPersonEvents(personId) {
    window.location.href = `gallery?person=${personId}`;
}
</script>
{% endblock %}
