FROM python:3.11-alpine

# Install system dependencies
RUN apk add --no-cache \
    build-base \
    cmake \
    curl \
    gfortran \
    openblas-dev \
    lapack-dev \
    jpeg-dev \
    zlib-dev \
    py3-numpy \
    py3-pillow \
    py3-opencv \
    py3-opencv-pyc

# Set working directory
WORKDIR /app

# Copy requirements and install Python dependencies (excluding opencv)
COPY requirements.txt .
RUN pip3 install --no-cache-dir fastapi uvicorn jinja2 python-multipart aiofiles structlog paho-mqtt pydantic pydantic-settings cryptography httpx requests

# Install face recognition dependencies (disable AVX/SSE4 on x86_64 to avoid illegal instructions)
RUN set -eux; \
    DLIB_VERSION=19.24.2; \
    if [ "$(uname -m)" = "x86_64" ]; then \
        echo "Building test dlib without AVX/SSE4 for virtualization compatibility..."; \
        DLIB_CPU_FLAGS="-O2 -pipe -mno-avx -mno-avx2 -mno-sse4.1 -mno-sse4.2 -mno-fma -march=x86-64 -mtune=generic"; \
        curl -L "https://files.pythonhosted.org/packages/source/d/dlib/dlib-${DLIB_VERSION}.tar.gz" -o /tmp/dlib.tar.gz; \
        tar -xzf /tmp/dlib.tar.gz -C /tmp; \
        cd "/tmp/dlib-${DLIB_VERSION}"; \
        python3 setup.py install \
            --no USE_AVX_INSTRUCTIONS \
            --no USE_SSE4_INSTRUCTIONS \
            --set USE_SSE2_INSTRUCTIONS=ON \
            --set DLIB_USE_BLAS=ON \
            --set DLIB_USE_LAPACK=ON \
            --set CMAKE_C_FLAGS="${DLIB_CPU_FLAGS}" \
            --set CMAKE_CXX_FLAGS="${DLIB_CPU_FLAGS}"; \
        cd /; \
        rm -rf "/tmp/dlib-${DLIB_VERSION}" /tmp/dlib.tar.gz; \
    else \
        pip3 install --no-cache-dir --no-build-isolation --no-binary :all: "dlib==${DLIB_VERSION}" || \
            echo "dlib installation failed - will run without face recognition"; \
    fi
RUN pip3 install --no-cache-dir face-recognition || \
    echo "face-recognition installation failed - will run without face recognition"

# Copy application files
COPY src/ ./src/
COPY web/ ./web/

# Create data directories
RUN mkdir -p /data/doorbell /data/faces /data/images

# Expose port
EXPOSE 8099

# Run the application directly
CMD ["python3", "src/app.py"]
